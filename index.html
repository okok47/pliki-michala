<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<title>FPS – Filmiki</title>
<style>
body { margin:0; overflow:hidden; background:black; }
#start {
  position:fixed; inset:0;
  display:flex; align-items:center; justify-content:center;
  font-size:32px; color:white; background:black;
  cursor:pointer; z-index:10;
}
#hud {
  position:fixed; top:10px; left:10px;
  color:white; font-family:Arial; z-index:5;
}
#crosshair {
  position:fixed; top:50%; left:50%;
  width:8px; height:8px;
  margin:-4px;
  border:2px solid white; z-index:5;
}
#gun {
  position:fixed;
  bottom:0; right:20%;
  width:200px; height:120px;
  background:#444;
  border-radius:20px 20px 0 0;
  z-index:5;
}
</style>
</head>
<body>

<div id="start">KLIKNIJ ABY START</div>
<div id="hud">HP: <span id="hp">100</span> | Fala: <span id="wave">1</span></div>
<div id="crosshair"></div>
<div id="gun"></div>

<script src="https://cdn.jsdelivr.net/npm/three@0.155.0/build/three.min.js"></script>

<script>
let scene, camera, renderer;
let enemies = [];
let wave = 1;
let keys = {};
let canShoot = true;
let playerHP = 100;

const MAP_LIMIT = 45;
const videos = ["film1.mp4","film2.mp4","film3.mp4","film4.mp4"];

const music = new Audio("muzyka.mp3");
music.loop = true;
music.volume = 1;

document.getElementById("start").onclick = async () => {
  document.getElementById("start").remove();
  init();
  spawnWave();
  try { await music.play(); } catch(e){}
  document.body.requestPointerLock();
  animate();
};

function init(){
  scene = new THREE.Scene();

  camera = new THREE.PerspectiveCamera(75, innerWidth/innerHeight, 0.1, 1000);
  camera.position.set(0,1.6,0);

  renderer = new THREE.WebGLRenderer();
  renderer.setSize(innerWidth, innerHeight);
  document.body.appendChild(renderer.domElement);

  scene.add(new THREE.AmbientLight(0xffffff,0.6));
  const light = new THREE.DirectionalLight(0xffffff,1);
  light.position.set(10,20,10);
  scene.add(light);

  const floor = new THREE.Mesh(
    new THREE.PlaneGeometry(100,100),
    new THREE.MeshStandardMaterial({color:0x222222})
  );
  floor.rotation.x = -Math.PI/2;
  scene.add(floor);
}

function spawnWave(){
  enemies.forEach(e=>scene.remove(e));
  enemies=[];
  for(let i=0;i<wave+2;i++) spawnEnemy();
}

function spawnEnemy(){
  const v = document.createElement("video");
  v.src = videos[Math.floor(Math.random()*videos.length)];
  v.loop = true; v.muted = true; v.play();

  const mesh = new THREE.Mesh(
    new THREE.PlaneGeometry(2,2),
    new THREE.MeshBasicMaterial({map:new THREE.VideoTexture(v), side:THREE.DoubleSide})
  );

  mesh.position.set((Math.random()-0.5)*80,1.5,(Math.random()-0.5)*80);
  mesh.userData = { hp: wave, speed: 0.01 + wave*0.002 };
  scene.add(mesh);
  enemies.push(mesh);
}

document.addEventListener("mousedown", ()=>{
  if(!canShoot) return;
  canShoot=false;

  const ray = new THREE.Raycaster();
  ray.setFromCamera(new THREE.Vector2(0,0), camera);
  const hit = ray.intersectObjects(enemies)[0];

  if(hit){
    hit.object.userData.hp--;
    if(hit.object.userData.hp <= 0){
      scene.remove(hit.object);
      enemies.splice(enemies.indexOf(hit.object),1);
    }
  }

  setTimeout(()=>canShoot=true,250);
});

function animate(){
  requestAnimationFrame(animate);

  const speed = 0.15;
  const dir = new THREE.Vector3();
  camera.getWorldDirection(dir);
  dir.y = 0;
  dir.normalize();

  const right = new THREE.Vector3().crossVectors(dir, new THREE.Vector3(0,1,0));

  if(keys.w) camera.position.addScaledVector(dir, speed);
  if(keys.s) camera.position.addScaledVector(dir, -speed);
  if(keys.a) camera.position.addScaledVector(right, -speed);
  if(keys.d) camera.position.addScaledVector(right, speed);

  camera.position.x = Math.max(-MAP_LIMIT, Math.min(MAP_LIMIT, camera.position.x));
  camera.position.z = Math.max(-MAP_LIMIT, Math.min(MAP_LIMIT, camera.position.z));

  enemies.forEach(e=>{
    e.lookAt(camera.position);
    e.position.lerp(camera.position, e.userData.speed);
    if(e.position.distanceTo(camera.position)<1.3){
      playerHP -= 0.3;
      document.getElementById("hp").textContent = Math.floor(playerHP);
      if(playerHP<=0){
        alert("MICHAŁ cię ZWINOGRONOWAŁ");
        location.reload();
      }
    }
  });

  if(enemies.length===0){
    wave++;
    document.getElementById("wave").textContent = wave;
    spawnWave();
  }

  renderer.render(scene,camera);
}

document.addEventListener("mousemove", e=>{
  if(document.pointerLockElement){
    camera.rotation.y -= e.movementX*0.002;
    camera.rotation.x -= e.movementY*0.002;
    camera.rotation.x = Math.max(-1.4,Math.min(1.4,camera.rotation.x));
  }
});

document.addEventListener("keydown", e=>keys[e.key.toLowerCase()]=true);
document.addEventListener("keyup", e=>keys[e.key.toLowerCase()]=false);

window.onresize = ()=>{
  camera.aspect = innerWidth/innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(innerWidth,innerHeight);
};
</script>
</body>
</html>
