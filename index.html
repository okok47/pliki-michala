<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<title>okk</title>
<style>
body { margin:0; overflow:hidden; background:black; }
#start {
  position:fixed; inset:0;
  display:flex; align-items:center; justify-content:center;
  font-size:32px; color:white; background:black;
  cursor:pointer; z-index:10;
}
#hud {
  position:fixed; top:10px; left:10px;
  color:white; font-family:Arial;
  z-index:5;
}
#crosshair {
  position:fixed; top:50%; left:50%;
  width:10px; height:10px;
  margin:-5px;
  border:2px solid white;
  z-index:5;
}
</style>
</head>
<body>

<div id="start">KLIKNIJ ABY START</div>
<div id="hud">Fala: <span id="wave">1</span></div>
<div id="crosshair"></div>

<script src="https://cdn.jsdelivr.net/npm/three@0.155.0/build/three.min.js"></script>

<script>
let scene, camera, renderer;
let enemies = [];
let wave = 1;
let keys = {};
let canShoot = true;

const videos = ["film1.mp4","film2.mp4","film3.mp4","film4.mp4"];

const music = new Audio("muzyka.mp3");
music.loop = true;
music.volume = 1;

document.getElementById("start").onclick = async () => {
  document.getElementById("start").remove();
  init();
  spawnWave();

  try { await music.play(); } catch(e){ alert("MUZYKA NIE GRA – ZŁY PLIK"); }

  document.body.requestPointerLock();
  animate();
};

function init(){
  scene = new THREE.Scene();

  camera = new THREE.PerspectiveCamera(75, innerWidth/innerHeight, 0.1, 1000);
  camera.position.y = 1.6;

  renderer = new THREE.WebGLRenderer();
  renderer.setSize(innerWidth, innerHeight);
  document.body.appendChild(renderer.domElement);

  const light = new THREE.DirectionalLight(0xffffff,1);
  light.position.set(5,10,5);
  scene.add(light);

  const floor = new THREE.Mesh(
    new THREE.PlaneGeometry(200,200),
    new THREE.MeshStandardMaterial({color:0x222222})
  );
  floor.rotation.x = -Math.PI/2;
  scene.add(floor);
}

function spawnWave(){
  enemies = [];
  for(let i=0;i<wave+2;i++) spawnEnemy();
}

function spawnEnemy(){
  const v = document.createElement("video");
  v.src = videos[Math.floor(Math.random()*videos.length)];
  v.loop = true; v.muted = true; v.play();

  const mesh = new THREE.Mesh(
    new THREE.PlaneGeometry(2,2),
    new THREE.MeshBasicMaterial({map:new THREE.VideoTexture(v), side:THREE.DoubleSide})
  );

  mesh.position.set((Math.random()-0.5)*30,1.5,(Math.random()-0.5)*30);
  mesh.userData = { hits: wave, speed: 0.01 + wave*0.003 };

  scene.add(mesh);
  enemies.push(mesh);
}

document.addEventListener("mousedown", ()=>{
  if(!canShoot) return;
  canShoot = false;

  const ray = new THREE.Raycaster();
  ray.setFromCamera(new THREE.Vector2(0,0), camera);
  const hit = ray.intersectObjects(enemies)[0];

  if(hit){
    hit.object.userData.hits--;
    if(hit.object.userData.hits <= 0){
      scene.remove(hit.object);
      enemies.splice(enemies.indexOf(hit.object),1);
    }
  }
  setTimeout(()=>canShoot=true,300);
});

function animate(){
  requestAnimationFrame(animate);

  const speed = 0.1;
  if(keys["w"]) camera.position.z -= speed;
  if(keys["s"]) camera.position.z += speed;
  if(keys["a"]) camera.position.x -= speed;
  if(keys["d"]) camera.position.x += speed;

  enemies.forEach(e=>{
    e.lookAt(camera.position);
    e.position.lerp(camera.position, e.userData.speed);
  });

  if(enemies.length === 0){
    wave++;
    document.getElementById("wave").textContent = wave;
    spawnWave();
  }

  renderer.render(scene,camera);
}

document.addEventListener("mousemove", e=>{
  if(document.pointerLockElement){
    camera.rotation.y -= e.movementX*0.002;
    camera.rotation.x -= e.movementY*0.002;
    camera.rotation.x = Math.max(-1.5,Math.min(1.5,camera.rotation.x));
  }
});

document.addEventListener("keydown", e=>keys[e.key.toLowerCase()]=true);
document.addEventListener("keyup", e=>keys[e.key.toLowerCase()]=false);

window.onresize = ()=>{
  camera.aspect = innerWidth/innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(innerWidth,innerHeight);
};
</script>
</body>
</html>
